# About

This web application is a frontend for the [Citellus](https://github.com/zerodayz/citellus) framework by rcernin

# Components

* python 2.x
* [Flask framework](http://flask.pocoo.org/)
* [Patternfly](http://www.patternfly.org)
* sqlite
* OAuth2 - Google


# Boilerplate

* [this tutorial](https://scotch.io/tutorials/build-a-crud-web-app-with-python-and-flask-part-one)


# Why a database?

* sosreport caching
* It's a lot easier working data out of a database. 
* It's going to be fun to pull out all kind of statistics out of our customer's sosreport without having to grep in 7TB of files.
* Trending ^^
* Store plugin metadata
* We can easily implement nice features like history and preferences.

# Known issues
* The first time we load a case, it takes ~30 seconds to parse and insert all the data in the DB. This might be because that we're using db.merge.
* It's my first python webapp, and I think some of the things could be better implement, like the helpers modules.
* ~~The first time we load the webapp (and when the browser cache is expired), it can take a good 30 seconds to download the assets.~~ This was solved by using a CDN for the assets.

# TODO
* ~~Generate a graphic with the points returned~~
* Possibility to yank the files when they are not there
* Possibility to compare (magui) two sosreports
* Upload a sosreport
* Keep an history of the searches for future reference
* Dynamic priorities on checks
* Toxify the code
* Describe each function
* Clean debug/repetitive code
* Fix helpers/sysstat.py - Need to make objects for stats and statset
* Sanitize and validate inputs
* Have a way to save the charts to share with others
* More advanced filters on metrics
* Add current resource graphs on the side of the report page
* Breadcrumbs
* Sort reports by date desc
* Size of reports 
* Generate a text report of the failure that could be pasted in a case
* Add metadata at the top of the reports

# Installation
## Python libraries

We first create python's virtual environment and we souce the activate file. WSGI will be able to use this environment using the python-home variable.

```
$ cd /var/www/nexus
$ virtualenv-2.7 .venv
$ . .venv/bin/activate
$ pip install -r requirements.txt
```

## User accounts

You can login using OAuth with Google as provider.

## Apache config

```
WSGIDaemonProcess nexus python-home=/var/www/nexus/.venv

WSGIProcessGroup nexus
WSGIApplicationGroup %{GLOBAL}
WSGIPythonHome /var/www/nexus/.venv

WSGIScriptAlias /nexus /var/www/nexus/run.py

<Directory /var/www/nexus>
    Require all granted
</Directory>
```

## DB init

The database is initialized based on the models.py file.

```
$ pwd
/var/www/nexus
$ . .venv/bin/activate
$ export FLASK_CONFIG=development
$ rm -rf migrations/
$ python manage.py db init
$ python manage.py db migrate
$ python manage.py db upgrade
 ```

 The script `bin/resetdb.sh` executes these commands.

## System Activity Report (SAR)
Most of the sosreport we get have SA files generated by sysstat v10. It appears that the format has changed considerably and it looks like sysstat-11 is not backward compatible, so you can't parse sysstat-10 files with sysstat-11. If you use sysstat-11 on your environment (Fedora for example), you will need to compile sysstat-10. This is not necessary on collab-shell for now.

This is how I build sysstat-10
```
 $ cd /git
 $ git clone https://github.com/sysstat/sysstat.git
 $ git checkout tags/v10.1.5
 $ git pull
 $ mv sysstat sysstat-10.1.5
 $ cd /git/sysstat-10.1.5
 $ ./configure
 $ make
```
I didn't want to run make install because I want to keep sysstat-11 for system wide.

I've included a copy of sadf binary in the bin/ folder. We now need to set the appropriate context on it (See SELinux Section)

## SELinux
* Give read access to the /cases folder to apache
```
# semanage fcontext -a -t httpd_sys_content_t '/cases(/.*)?'
```

* Give write access to the sqlite database
```
# semanage fcontext -a -t httpd_sys_rw_content_t '/var/www/nexus/app(/.*)?'
# chown -R apache:apache /var/www/nexus/db/
```

* Give execute access to the binary directory
```
# semanage fcontext -a -t httpd_sys_script_exec_t '/var/www/nexus/bin(/.*)?'
# semanage fcontext -a -t httpd_sys_script_exec_t '/git/citellus(/.*)?'
# chown -R apache:apache /var/www/nexus/bin/
```

* Restorecon
```
# restorecon -R -F -v /var/www/nexus/ /cases/ /git/citellus/
```

# Citellus Team

* rcernin
* [iranzo](https://iranzo.github.io/)
* pcaruana
* mschuppert
* [dvd](https://valleedelisle.com)
